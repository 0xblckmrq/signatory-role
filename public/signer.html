async function connectAndSign() {
  const status = document.getElementById("status");
  const sigBox = document.getElementById("signature");
  const challenge = document.getElementById("msg").value;

  if (!challenge) return alert("Missing challenge");

  status.innerText = "Connecting wallet...";
  sigBox.style.display = "none";

  try {
    let provider;

    if (window.ethereum) {
      // MetaMask
      await window.ethereum.request({ method: "eth_requestAccounts" });
      provider = new ethers.BrowserProvider(window.ethereum);
    } else {
      // WalletConnect for mobile
      const wcProvider = new WalletConnectProvider.default({
        rpc: { 1: `https://mainnet.infura.io/v3/${window.INFURA_KEY}` },
        qrcode: true
      });
      await wcProvider.enable();
      provider = new ethers.BrowserProvider(wcProvider);
    }

    // Get signer immediately after connect
    const signer = await provider.getSigner();

    status.innerText = "Signing message...";
    const sig = await signer.signMessage(challenge);

    sigBox.style.display = "block";
    sigBox.innerText = sig;

    try {
      await navigator.clipboard.writeText(sig);
      status.innerText = "✅ Signature copied. Paste it in Discord with /signature";
    } catch {
      status.innerText = "✅ Signature generated. Copy it manually and paste in Discord with /signature";
    }

  } catch (err) {
    console.error(err);
    status.innerText = "❌ " + err.message;
  }
}
