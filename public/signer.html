<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>human.tech Covenant Signatory Verification</title>
<style>
  body { font-family: sans-serif; padding:20px; max-width:600px; margin:auto; }
  button { padding:10px 15px; margin-top:20px; font-size:16px; cursor:pointer; }
  #status { margin-top:15px; font-weight:bold; word-break: break-word; }
  input { width:100%; padding:8px; margin-top:5px; }
</style>
</head>
<body>
<h2>human.tech Covenant Signatory Verification</h2>
<p>Connect the wallet used to sign the covenant and sign the challenge below.</p>
<p>Challenge:</p>
<input id="msg" readonly>
<br>
<button id="signBtn">Connect & Sign</button>
<p id="status"></p>

<script type="module">
import WalletConnectProvider from "https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider/dist/esm/index.min.js";

const urlParams = new URLSearchParams(window.location.search);
const challenge = urlParams.get("challenge");
const userId = urlParams.get("userId");

const msgInput = document.getElementById("msg");
const status = document.getElementById("status");
const btn = document.getElementById("signBtn");

btn.addEventListener("click", async () => {
  status.innerText = "Connecting wallet...";
  let provider;

  try {
    // Desktop MetaMask
    if (window.ethereum) {
      provider = window.ethereum;
      await provider.request({ method: "eth_requestAccounts" });
    } else {
      // WalletConnect
      provider = new WalletConnectProvider({
        rpc: { 1: "https://mainnet.infura.io/v3/84842078b09946638c03157f83405213" }
      });
      await provider.enable();
    }

    // Get account
    const accounts = await provider.request({ method: "eth_accounts" });
    const account = accounts[0];
    status.innerText = `Wallet connected: ${account}\nSigning challenge...`;

    // Show challenge now (after connection)
    msgInput.value = challenge;

    // Sign challenge
    const signature = await provider.request({
      method: "personal_sign",
      params: [challenge, account]
    });

    status.innerText = "‚úÖ Signature created! Submitting to bot...";

    // POST signature to bot
    const resp = await fetch("/api/signature", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, signature })
    });

    const result = await resp.json();
    if (result.success) {
      status.innerText = "üéâ Verification complete! Role assigned. Private channel will be deleted shortly.";
    } else {
      status.innerText = "‚ùå Verification failed: " + (result.error || "Unknown error");
    }

  } catch (err) {
    console.error(err);
    status.innerText = "‚ùå Error: " + err.message;
  }
});
</script>
</body>
</html>
